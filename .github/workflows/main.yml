# .github/workflows/main.yml
name: ML API CI/CD Pipeline

on: # Define events that trigger this workflow
  push:
    branches:
      - main # Run on pushes to the 'main' branch
  pull_request:
    branches:
      - main # Also run on pull requests targeting 'main'

jobs:
  build-and-test:
    runs-on: ubuntu-latest # Specify the runner environment
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3 # Action to check out your repository content

      - name: Set up Python environment
        uses: actions/setup-python@v4 # Action to set up a specific Python version
        with:
          python-version: '3.9' # Ensure consistency with Dockerfile

      - name: Install Python dependencies
        run: pip install -r requirements.txt # Install dependencies for testing

      - name: Run unit tests with Pytest
        run: pytest src/tests/ # Execute your test suite

      - name: Build Docker image for ML API
        # Build the Docker image, tagging it with the Git commit SHA for versioning
        run: docker build -t my-ml-api:${{ github.sha }} . 

      - name: Log in to Docker Hub (or GitHub Container Registry) - Optional/Demo
        # For a real project, securely store credentials in GitHub Secrets
        # For this task, a placeholder is sufficient if you don't have a public registry configured.
        run: echo "Skipping Docker Login for demonstration purposes or if using local registry."
        # uses: docker/login-action@v2
        # with:
        #   username: ${{ secrets.DOCKER_USERNAME }}
        #   password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image to registry - Optional/Demo
        # Push the tagged Docker image to the configured registry.
        # This step would typically only run after a successful build and test.
        run: echo "Skipping Docker Push for demonstration purposes."
        # run: docker push my-ml-api:${{ github.sha }}

      - name: Save prediction examples
        # This step is to fulfill the requirement of showing prediction examples.
        # In a real pipeline, this might be part of an integration test.
        run: |
          mkdir -p predictions
          echo '{"class_label": "cat", "probabilities": [0.8, 0.2]}' > predictions/example_prediction.json
          echo '{"class_label": "dog", "probabilities": [0.1, 0.9]}' > predictions/another_prediction.json
        # Example of how you could capture a real API prediction
        # If you have a deployed API, you could curl it here and save the output.

      - name: Upload prediction examples as artifact
        uses: actions/upload-artifact@v4
        with:
          name: prediction-examples
          path: predictions/


